// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// USER & AUTH
// ========================================

enum UserRole {
  USER
  ORGANIZER
  ADMIN
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          UserRole  @default(USER)
  bio           String?

  accounts       Account[]
  sessions       Session[]
  savedEvents    SavedEvent[]
  followedTopics FollowedTopic[]
  followedCities FollowedCity[]
  comments       Comment[]
  organization   Organization?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ========================================
// ORGANIZATIONS
// ========================================

enum OrganizationType {
  MUSEUM
  UNIVERSITY
  NGO
  CULTURAL_CENTER
  TOUR_COMPANY
  LOCAL_ORGANIZATION
  GOVERNMENT
  PRIVATE
  OTHER
}

model Organization {
  id          String           @id @default(cuid())
  name        String
  slug        String           @unique
  type        OrganizationType
  description String?
  logo        String?
  website     String?
  email       String?
  phone       String?
  address     String?

  instagram String?
  telegram  String?
  twitter   String?
  facebook  String?
  linkedin  String?

  isVerified Boolean   @default(false)
  verifiedAt DateTime?

  userId String  @unique
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  events Event[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ========================================
// EVENTS
// ========================================

enum EventStatus {
  PENDING
  APPROVED
  REJECTED
}

enum EventStyle {
  EXHIBITION
  FESTIVAL
  CONFERENCE
  RELIGIOUS
  TOURISM
  SPORTS
  EDUCATIONAL
  OTHER
}

enum EventType {
  NATIONAL
  RELIGIOUS
  ECONOMIC
  ARTISTIC
  SCIENTIFIC
  TOURISM
  SPORTS
}

enum FixedVariable {
  FIXED
  VARIABLE
}

model Event {
  id    String @id @default(cuid())
  title String
  slug  String @unique

  style           EventStyle
  type            EventType
  fixedOrVariable FixedVariable

  country   String  @default("Iran")
  city      String
  venue     String
  address   String?
  latitude  Float?
  longitude Float?

  dateRangeText        String
  startDate            DateTime
  endDate              DateTime
  registrationDeadline DateTime?
  durationText         String?

  shortDescription String
  description      String
  opportunities    String?
  challenges       String?

  featuredImage String?
  images        String? // JSON array as string
  videoUrl      String?

  organizerName   String?
  organizerEmail  String?
  organizerPhone  String?
  website         String?
  registrationUrl String?

  status         EventStatus @default(PENDING)
  approvedAt     DateTime?
  rejectedReason String?

  metaTitle       String?
  metaDescription String?
  keywords        String? // JSON array as string

  viewCount  Int @default(0)
  saveCount  Int @default(0)
  shareCount Int @default(0)

  organizationId String?
  organization   Organization?   @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  categories     EventCategory[]
  savedBy        SavedEvent[]
  comments       Comment[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  @@index([city])
  @@index([type])
  @@index([style])
  @@index([startDate])
  @@index([status])
}

// ========================================
// CATEGORIES
// ========================================

model Category {
  id          String  @id @default(cuid())
  name        String
  nameEn      String
  slug        String  @unique
  description String?
  icon        String?
  color       String?

  events    EventCategory[]
  followers FollowedTopic[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventCategory {
  eventId    String
  categoryId String

  event    Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([eventId, categoryId])
}

// ========================================
// CITIES
// ========================================

model City {
  id          String  @id @default(cuid())
  name        String
  nameEn      String
  slug        String  @unique
  province    String
  description String?
  image       String?
  latitude    Float
  longitude   Float

  metaTitle       String?
  metaDescription String?

  followers FollowedCity[]

  eventCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ========================================
// USER INTERACTIONS
// ========================================

model SavedEvent {
  id      String @id @default(cuid())
  userId  String
  eventId String

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, eventId])
}

model FollowedTopic {
  id         String @id @default(cuid())
  userId     String
  categoryId String

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, categoryId])
}

model FollowedCity {
  id     String @id @default(cuid())
  userId String
  cityId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  city City @relation(fields: [cityId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, cityId])
}

model Comment {
  id      String   @id @default(cuid())
  content String
  rating  Int?
  images  String? // JSON array as string

  isApproved Boolean @default(false)

  userId  String
  eventId String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventId])
  @@index([userId])
}
