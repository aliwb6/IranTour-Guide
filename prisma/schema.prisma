// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  USER
  ORGANIZER
  ADMIN
}

enum EventStatus {
  PENDING
  APPROVED
  REJECTED
}

enum OrganizationType {
  MUSEUM
  UNIVERSITY
  NGO
  CULTURAL_CENTER
  TOUR_COMPANY
  LOCAL_ORGANIZATION
  GOVERNMENT
  PRIVATE
  OTHER
}

enum EventStyle {
  EXHIBITION
  FESTIVAL
  CONFERENCE
  RELIGIOUS
  TOURISM
  SPORTS
  EDUCATIONAL
  OTHER
}

enum EventType {
  NATIONAL
  RELIGIOUS
  ECONOMIC
  ARTISTIC
  SCIENTIFIC
  TOURISM
  SPORTS
}

enum FixedVariable {
  FIXED
  VARIABLE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  ZARINPAL
  SAMAN
  MELLAT
  PASARGAD
  SADERAT
  PARSIAN
  CASH
  CARD
  OTHER
}

// User model
model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  password      String
  image         String?
  bio           String?
  role          UserRole  @default(USER)
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts       Account[]
  sessions       Session[]
  savedEvents    SavedEvent[]
  followedTopics FollowedTopic[]
  followedCities FollowedCity[]
  organization   Organization?
  bookings       Booking[]
  reviews        Review[]
}

// NextAuth Account model
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// NextAuth Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// NextAuth VerificationToken model
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Saved Events
model SavedEvent {
  id        String   @id @default(cuid())
  userId    String
  eventId   String
  eventSlug String
  savedAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, eventSlug])
}

// Followed Topics
model FollowedTopic {
  id         String   @id @default(cuid())
  userId     String
  topicName  String
  followedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, topicName])
}

// Followed Cities
model FollowedCity {
  id         String   @id @default(cuid())
  userId     String
  cityName   String
  citySlug   String
  followedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, citySlug])
}

// Organization model
model Organization {
  id          String            @id @default(cuid())
  userId      String            @unique
  name        String
  type        OrganizationType
  description String?
  logo        String?
  website     String?
  email       String?
  phone       String?
  address     String?
  instagram   String?
  telegram    String?
  twitter     String?
  facebook    String?
  linkedin    String?
  isVerified  Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  events Event[]
}

// Category model
model Category {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events EventOnCategory[]
}

// Event model
model Event {
  id                   String        @id @default(cuid())
  title                String
  slug                 String        @unique
  style                EventStyle
  type                 EventType
  fixedOrVariable      FixedVariable
  country              String        @default("Iran")
  city                 String
  venue                String
  address              String?
  latitude             Float?
  longitude            Float?
  dateRangeText        String
  startDate            DateTime
  endDate              DateTime
  registrationDeadline DateTime?
  durationText         String?

  // Pricing & Capacity
  basePrice            Float?
  currency             String        @default("IRR")
  maxCapacity          Int?
  availableSpots       Int?
  isBookable           Boolean       @default(true)

  // Content
  shortDescription     String
  description          String
  opportunities        String?
  challenges           String?

  // Media
  featuredImage        String?
  images               String[]
  videoUrl             String?

  // Contact
  organizerName        String?
  organizerEmail       String?
  organizerPhone       String?
  website              String?
  registrationUrl      String?

  // Status
  status               EventStatus   @default(PENDING)
  approvedAt           DateTime?
  rejectedReason       String?

  // SEO
  metaTitle            String?
  metaDescription      String?
  keywords             String[]

  // Analytics
  viewCount            Int           @default(0)
  saveCount            Int           @default(0)
  shareCount           Int           @default(0)
  bookingCount         Int           @default(0)

  organizationId       String?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  publishedAt          DateTime?

  organization Organization?      @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  categories   EventOnCategory[]
  analytics    Analytics[]
  bookings     Booking[]
  reviews      Review[]

  @@index([city])
  @@index([type])
  @@index([status])
  @@index([organizationId])
  @@index([startDate])
}

// EventOnCategory junction table
model EventOnCategory {
  id         String   @id @default(cuid())
  eventId    String
  categoryId String
  createdAt  DateTime @default(now())

  event    Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([eventId, categoryId])
}

// Analytics model
model Analytics {
  id        String   @id @default(cuid())
  eventId   String
  action    String   // "view", "save", "share"
  createdAt DateTime @default(now())

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([action])
  @@index([createdAt])
}

// Post model (for blog and cultural guide)
model Post {
  id              String   @id @default(cuid())
  title           String
  slug            String   @unique
  excerpt         String?
  content         String
  featuredImage   String?
  type            String   // "BLOG" or "GUIDE"
  metaTitle       String?
  metaDescription String?
  keywords        String[]
  viewCount       Int      @default(0)
  isPublished     Boolean  @default(false)
  publishedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([slug])
  @@index([type])
  @@index([isPublished])
}

// Booking model
model Booking {
  id                String        @id @default(cuid())
  bookingCode       String        @unique
  userId            String
  eventId           String
  eventTitle        String
  eventDate         DateTime

  // Contact Information
  firstName         String
  lastName          String
  email             String
  phone             String
  nationalId        String?

  // Booking Details
  numberOfAdults    Int           @default(1)
  numberOfChildren  Int           @default(0)
  totalParticipants Int
  specialRequests   String?
  notes             String?

  // Pricing
  pricePerPerson    Float
  childrenPrice     Float?
  totalPrice        Float
  discount          Float?        @default(0)
  finalPrice        Float

  // Status & Timestamps
  status            BookingStatus @default(PENDING)
  confirmedAt       DateTime?
  cancelledAt       DateTime?
  cancellationReason String?
  completedAt       DateTime?
  expiresAt         DateTime?

  // Additional Info
  source            String?       // "website", "mobile_app", etc
  referenceNumber   String?

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  event   Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  payment Payment?

  @@index([userId])
  @@index([eventId])
  @@index([status])
  @@index([bookingCode])
  @@index([createdAt])
}

// Payment model
model Payment {
  id                String        @id @default(cuid())
  bookingId         String        @unique

  // Payment Details
  amount            Float
  currency          String        @default("IRR")
  paymentMethod     PaymentMethod
  status            PaymentStatus @default(PENDING)

  // Gateway Information
  gatewayName       String?
  transactionId     String?       @unique
  referenceId       String?
  trackingCode      String?
  cardNumber        String?       // Last 4 digits only

  // Gateway Response
  gatewayResponse   String?       // JSON string
  errorMessage      String?

  // Timestamps
  paidAt            DateTime?
  refundedAt        DateTime?
  refundAmount      Float?
  refundReason      String?

  // Additional Info
  ipAddress         String?
  userAgent         String?

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([status])
  @@index([transactionId])
  @@index([createdAt])
}

// Review model
model Review {
  id              String    @id @default(cuid())
  userId          String
  eventId         String
  bookingId       String?   // Optional: link to booking if user attended

  // Review Content
  rating          Int       // 1-5 stars
  title           String?
  comment         String
  pros            String?   // Positive points
  cons            String?   // Negative points

  // Media
  images          String[]  // Array of image URLs

  // Verification & Moderation
  isVerified      Boolean   @default(false)  // Verified attendance
  isApproved      Boolean   @default(false)  // Admin approval
  isPinned        Boolean   @default(false)  // Highlighted review

  // Interaction
  helpfulCount    Int       @default(0)
  reportCount     Int       @default(0)

  // Organization Response
  organizationResponse String?
  respondedAt          DateTime?

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  approvedAt      DateTime?

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([eventId])
  @@index([userId])
  @@index([rating])
  @@index([isApproved])
  @@index([createdAt])
}
